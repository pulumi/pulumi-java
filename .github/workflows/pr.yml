on:
  pull_request:
    paths-ignore:
      - 'CHANGELOG.md'
      - 'CHANGELOG_PENDING.md'
  push:
    branches:
      - main
    paths-ignore:
      - 'CHANGELOG.md'
      - 'CHANGELOG_PENDING.md'

# TODO[pulumi/java#10] protect jobs from crypto mining PR attacks
# before making the repo public.
env:
  PULUMI_API: https://api.pulumi-staging.io
  PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
  AWS_REGION: us-west-2
  PULUMI_JVM_TASK_TIMEOUT_IN_MILLIS: 60000
jobs:

  publish-java-sdk-snapshot:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: 'adopt'
          cache: 'gradle'
      - name: Build and unit-test Pulumi Java SDK
        uses: gradle/gradle-build-action@4137be6a8bf7d7133955359dbd952c0ca73b1021
        with:
          arguments: -Dversion=0.0.1-SNAPSHOT publish
          build-root-directory: sdk/jvm

  prerequisites:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: 'adopt'
          cache: 'gradle'
      - name: Validate Gradle wrapper
        uses: gradle/wrapper-validation-action@e6e38bacfdf1a337459f332974bb2327a31aaf4b
      - name: Set up Go 1.17.x
        uses: actions/setup-go@v2
        with:
          go-version: 1.17.x
      - name: Configure Go cache
        id: go-cache-paths
        run: |
          echo "::set-output name=go-build::$(go env GOCACHE)"
          echo "::set-output name=go-mod::$(go env GOMODCACHE)"
      - name: Set up Go cache
        uses: actions/cache@v2
        id: go-cache
        with:
          path: |
              ${{ steps.go-cache-paths.outputs.go-build }}
              ${{ steps.go-cache-paths.outputs.go-mod }}
          key: go-cache-${{ hashFiles('**/go.sum') }}
      - name: Ensure dependencies
        run: make ensure
      - name: Build and unit-test Pulumi Java SDK
        uses: gradle/gradle-build-action@4137be6a8bf7d7133955359dbd952c0ca73b1021
        with:
          arguments: build
          build-root-directory: sdk/jvm
      - name: Publish Pulumi Java SDK to a local Maven repo
        timeout-minutes: 2
        run: make install_sdk
      - name: Build Pulumi JVM Language Provider and Codegen
        run: make build_go
      - name: Test Pulumi JVM Language Provider and Codegen
        run: make test_go
      - name: Integration tests
        run: make integration_tests
    strategy:
      fail-fast: true
  providers:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        provider:
        - random
        - azure-native
        - google-native
        - gcp
        - aws
        - aws-native
        - kubernetes
        - docker
        - eks
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: 'adopt'
          cache: 'gradle'
      - name: Validate Gradle wrapper
        uses: gradle/wrapper-validation-action@e6e38bacfdf1a337459f332974bb2327a31aaf4b
      - name: Set up Go 1.17.x
        uses: actions/setup-go@v2
        with:
          go-version: 1.17.x
      - name: Configure Go cache
        id: go-cache-paths
        run: |
          echo "::set-output name=go-build::$(go env GOCACHE)"
          echo "::set-output name=go-mod::$(go env GOMODCACHE)"
      - name: Set up Go cache
        uses: actions/cache@v2
        id: go-cache
        with:
          path: |
              ${{ steps.go-cache-paths.outputs.go-build }}
              ${{ steps.go-cache-paths.outputs.go-mod }}
          key: go-cache-${{ hashFiles('**/go.sum') }}
      - name: Ensure dependencies
        run: make ensure
      - name: Build and unit-test Pulumi Java SDK
        uses: gradle/gradle-build-action@4137be6a8bf7d7133955359dbd952c0ca73b1021
        with:
          arguments: build
          build-root-directory: sdk/jvm
      - name: Publish Pulumi Java SDK to a local Maven repo
        timeout-minutes: 2
        run: make install_sdk
      - name: Build JVM SDK provider
        run: make provider.${PROVIDER}.install
        env:
          PROVIDER: ${{ matrix.provider }}
  example1:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: 'adopt'
          cache: 'gradle'
      - name: Validate Gradle wrapper
        uses: gradle/wrapper-validation-action@e6e38bacfdf1a337459f332974bb2327a31aaf4b
      - name: Set up Go 1.17.x
        uses: actions/setup-go@v2
        with:
          go-version: 1.17.x
      - name: Configure Go cache
        id: go-cache-paths
        run: |
          echo "::set-output name=go-build::$(go env GOCACHE)"
          echo "::set-output name=go-mod::$(go env GOMODCACHE)"
      - name: Set up Go cache
        uses: actions/cache@v2
        id: go-cache
        with:
          path: |
              ${{ steps.go-cache-paths.outputs.go-build }}
              ${{ steps.go-cache-paths.outputs.go-mod }}
          key: go-cache-${{ hashFiles('**/go.sum') }}
      - name: Ensure dependencies
        run: make ensure
      - name: Publish Pulumi Java SDK to a local Maven repo
        timeout-minutes: 2
        run: make install_sdk
      - name: Install Pulumi CLI
        uses: pulumi/action-install-pulumi-cli@v2
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-region: ${{ env.AWS_REGION }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          role-duration-seconds: 3600
          role-session-name: ${{ env.PROVIDER }}@githubActions
          role-to-assume: ${{ secrets.AWS_CI_ROLE_ARN }}
      - name: Install Pulumi Resource Plugins
        run: |
          pulumi plugin install resource aws v4.37.3;
          pulumi plugin install resource azure-native v1.56.0;
          pulumi plugin install resource kubernetes v3.15.1;
          pulumi plugin install resource gcp v6.11.0;
          pulumi plugin install resource random v4.3.1;
      - name: run example aws-java-webserver
        run: |
          make bin/pulumi-language-jvm
          make provider.aws.build provider.aws.install
          export PATH="$PATH:$(pwd)/bin/" &&
            ss=0
            cd tests/examples/aws-java-webserver &&
            ./gradlew install || ((ss++))
            pulumi stack rm dev --yes || true
            pulumi stack init dev || ((ss++))
            pulumi preview || ((ss++))
            exit $ss
  example2:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: 'adopt'
          cache: 'gradle'
      - name: Validate Gradle wrapper
        uses: gradle/wrapper-validation-action@e6e38bacfdf1a337459f332974bb2327a31aaf4b
      - name: Set up Go 1.17.x
        uses: actions/setup-go@v2
        with:
          go-version: 1.17.x
      - name: Configure Go cache
        id: go-cache-paths
        run: |
          echo "::set-output name=go-build::$(go env GOCACHE)"
          echo "::set-output name=go-mod::$(go env GOMODCACHE)"
      - name: Set up Go cache
        uses: actions/cache@v2
        id: go-cache
        with:
          path: |
              ${{ steps.go-cache-paths.outputs.go-build }}
              ${{ steps.go-cache-paths.outputs.go-mod }}
          key: go-cache-${{ hashFiles('**/go.sum') }}
      - name: Ensure dependencies
        run: make ensure
      - name: Publish Pulumi Java SDK to a local Maven repo
        timeout-minutes: 2
        run: make install_sdk
      - name: Install Pulumi CLI
        uses: pulumi/action-install-pulumi-cli@v2
      - name: Install Pulumi Resource Plugins
        run: |
          pulumi plugin install resource aws v4.37.3;
          pulumi plugin install resource azure-native v1.56.0;
          pulumi plugin install resource kubernetes v3.15.1;
          pulumi plugin install resource gcp v6.11.0;
          pulumi plugin install resource random v4.3.1;
      #- name: Auth
      #  uses: azure/login@v1
      #  with:
      #    creds: ${{ secrets.AZURE_IAM_SP_CREDS }}
      - env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
        name: run example azure-java-appservice-sql
        run: |
          make bin/pulumi-language-jvm
          make provider.azure-native.build
          make provider.azure-native.install
          export PATH="$PATH:$(pwd)/bin/" &&
            cd tests/examples/azure-java-appservice-sql &&
            ./gradlew install &&
            ss=0
            pulumi stack rm dev --yes || true
            pulumi stack init dev || ((ss++))
            pulumi config set azure-native:location westus
            pulumi config set azure-java-appservice-sql:sqlPassword not-a-real-password
            pulumi preview || ((ss++))
            exit $ss
  example3:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: 'adopt'
          cache: 'gradle'
      - name: Validate Gradle wrapper
        uses: gradle/wrapper-validation-action@e6e38bacfdf1a337459f332974bb2327a31aaf4b
      - name: Set up Go 1.17.x
        uses: actions/setup-go@v2
        with:
          go-version: 1.17.x
      - name: Configure Go cache
        id: go-cache-paths
        run: |
          echo "::set-output name=go-build::$(go env GOCACHE)"
          echo "::set-output name=go-mod::$(go env GOMODCACHE)"
      - name: Set up Go cache
        uses: actions/cache@v2
        id: go-cache
        with:
          path: |
              ${{ steps.go-cache-paths.outputs.go-build }}
              ${{ steps.go-cache-paths.outputs.go-mod }}
          key: go-cache-${{ hashFiles('**/go.sum') }}
      - name: Ensure dependencies
        run: make ensure
      - name: Publish Pulumi Java SDK to a local Maven repo
        timeout-minutes: 2
        run: make install_sdk
      - name: Install Pulumi CLI
        uses: pulumi/action-install-pulumi-cli@v2
      - name: Install Pulumi Resource Plugins
        run: |
          pulumi plugin install resource aws v4.37.3;
          pulumi plugin install resource azure-native v1.56.0;
          pulumi plugin install resource kubernetes v3.15.1;
          pulumi plugin install resource gcp v6.11.0;
          pulumi plugin install resource random v4.3.1;
      - uses: google-github-actions/setup-gcloud@v0
        with:
          project_id: pulumi-development
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true
      - name: run example gcp-java-gke-hello-world
        run: |
          make bin/pulumi-language-jvm
          make provider.gcp.build provider.gcp.install
          make provider.kubernetes.build provider.kubernetes.install
          export PATH="$PATH:$(pwd)/bin/" &&
            cd tests/examples/gcp-java-gke-hello-world &&
            ss=0
            ./gradlew install || ((ss++))
            pulumi stack rm dev --yes || true
            pulumi stack init dev || ((ss++))
            pulumi config set gcp:zone us-west1-a
            pulumi preview || ((ss++))
            exit $ss
  example4:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: 'adopt'
          cache: 'maven'
      - name: Set up Go 1.17.x
        uses: actions/setup-go@v2
        with:
          go-version: 1.17.x
      - name: Configure Go cache
        id: go-cache-paths
        run: |
          echo "::set-output name=go-build::$(go env GOCACHE)"
          echo "::set-output name=go-mod::$(go env GOMODCACHE)"
      - name: Set up Go cache
        uses: actions/cache@v2
        id: go-cache
        with:
          path: |
              ${{ steps.go-cache-paths.outputs.go-build }}
              ${{ steps.go-cache-paths.outputs.go-mod }}
          key: go-cache-${{ hashFiles('**/go.sum') }}
      - name: Ensure dependencies
        run: make ensure
      - name: Publish Pulumi Java SDK to a local Maven repo
        timeout-minutes: 2
        run: make install_sdk
      - name: Install Pulumi CLI
        uses: pulumi/action-install-pulumi-cli@v2
      - name: Install Pulumi Resource Plugins
        run: |
          pulumi plugin install resource aws v4.37.3;
          pulumi plugin install resource azure-native v1.56.0;
          pulumi plugin install resource kubernetes v3.15.1;
          pulumi plugin install resource gcp v6.11.0;
          pulumi plugin install resource random v4.3.1;
      - name: run example minimal
        run: |
          make bin/pulumi-language-jvm
          export PATH="$PATH:$(pwd)/bin/" &&
            cd tests/examples/minimal &&
            ss=0
            mvn --no-transfer-progress package || ((ss++))
            pulumi destroy -s dev --yes || true
            pulumi stack rm dev --yes || true
            pulumi stack init dev || ((ss++))
            pulumi config set minimal:name foo
            pulumi config set minimal:secret bar
            pulumi preview || ((ss++))
            pulumi up -s dev --yes || ((ss++))
            pulumi destroy -s dev --yes || ((ss++))
            exit $ss
  example5:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: 'adopt'
          cache: 'maven'
      - name: Set up Go 1.17.x
        uses: actions/setup-go@v2
        with:
          go-version: 1.17.x
      - name: Configure Go cache
        id: go-cache-paths
        run: |
          echo "::set-output name=go-build::$(go env GOCACHE)"
          echo "::set-output name=go-mod::$(go env GOMODCACHE)"
      - name: Set up Go cache
        uses: actions/cache@v2
        id: go-cache
        with:
          path: |
              ${{ steps.go-cache-paths.outputs.go-build }}
              ${{ steps.go-cache-paths.outputs.go-mod }}
          key: go-cache-${{ hashFiles('**/go.sum') }}
      - name: Ensure dependencies
        run: make ensure
      - name: Publish Pulumi Java SDK to a local Maven repo
        timeout-minutes: 2
        run: make install_sdk
      - name: Install Pulumi CLI
        uses: pulumi/action-install-pulumi-cli@v2
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-region: ${{ env.AWS_REGION }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          role-duration-seconds: 3600
          role-session-name: ${{ env.PROVIDER }}@githubActions
          role-to-assume: ${{ secrets.AWS_CI_ROLE_ARN }}
      - name: Install Pulumi Resource Plugins
        run: |
          pulumi plugin install resource aws v4.37.3;
          pulumi plugin install resource aws-native v0.12.0
          pulumi plugin install resource azure-native v1.56.0;
          pulumi plugin install resource kubernetes v3.15.1;
          pulumi plugin install resource gcp v6.11.0;
          pulumi plugin install resource random v4.3.1;
      - name: run example aws-native-java-s3-folder
        run: |
          make bin/pulumi-language-jvm
          make provider.aws.build provider.aws.install
          make provider.aws-native.build provider.aws-native.install
          export PATH="$PATH:$(pwd)/bin/" &&
            cd tests/examples/aws-native-java-s3-folder &&
            ss=0
            ./gradlew install || ((ss++))
            pulumi destroy -s dev --yes || true
            pulumi stack rm dev --yes || true
            pulumi stack init dev || ((ss++))
            pulumi preview || ((ss++))
            exit $ss
  example6:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: 'adopt'
          cache: 'gradle'
      - name: Validate Gradle wrapper
        uses: gradle/wrapper-validation-action@e6e38bacfdf1a337459f332974bb2327a31aaf4b
      - name: Set up Go 1.17.x
        uses: actions/setup-go@v2
        with:
          go-version: 1.17.x
      - name: Configure Go cache
        id: go-cache-paths
        run: |
          echo "::set-output name=go-build::$(go env GOCACHE)"
          echo "::set-output name=go-mod::$(go env GOMODCACHE)"
      - name: Set up Go cache
        uses: actions/cache@v2
        id: go-cache
        with:
          path: |
              ${{ steps.go-cache-paths.outputs.go-build }}
              ${{ steps.go-cache-paths.outputs.go-mod }}
          key: go-cache-${{ hashFiles('**/go.sum') }}
      - name: Ensure dependencies
        run: make ensure
      - name: Publish Pulumi Java SDK to a local Maven repo
        timeout-minutes: 2
        run: make install_sdk
      - name: Install Pulumi CLI
        uses: pulumi/action-install-pulumi-cli@v2
      - name: Install Pulumi Resource Plugins
        run: |
          pulumi plugin install resource aws v4.37.3;
          pulumi plugin install resource azure-native v1.56.0;
          pulumi plugin install resource kubernetes v3.15.1;
          pulumi plugin install resource gcp v6.11.0;
          pulumi plugin install resource random v4.3.1;
      #- name: Auth
      #  uses: azure/login@v1
      #  with:
      #    creds: ${{ secrets.AZURE_IAM_SP_CREDS }}
      - env:
          PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
        name: run example azure-java-static-website
        run: |
          make bin/pulumi-language-jvm
          make provider.azure-native.build provider.azure-native.install
          export PATH="$PATH:$(pwd)/bin/" &&
            cd tests/examples/azure-java-static-website &&
            ss=0
            ./gradlew install || ((ss++))
            pulumi stack rm dev --yes || true
            pulumi stack init dev || ((ss++))
            pulumi config set azure-native:location westus
            pulumi preview || ((ss++))
            exit $ss
  example7:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: 'adopt'
          cache: 'maven'
      - name: Set up Go 1.17.x
        uses: actions/setup-go@v2
        with:
          go-version: 1.17.x
      - name: Configure Go cache
        id: go-cache-paths
        run: |
          echo "::set-output name=go-build::$(go env GOCACHE)"
          echo "::set-output name=go-mod::$(go env GOMODCACHE)"
      - name: Set up Go cache
        uses: actions/cache@v2
        id: go-cache
        with:
          path: |
              ${{ steps.go-cache-paths.outputs.go-build }}
              ${{ steps.go-cache-paths.outputs.go-mod }}
          key: go-cache-${{ hashFiles('**/go.sum') }}
      - name: Ensure dependencies
        run: make ensure
      - name: Publish Pulumi Java SDK to a local Maven repo
        timeout-minutes: 2
        run: make install_sdk
      - name: Install Pulumi CLI
        uses: pulumi/action-install-pulumi-cli@v2
      - name: Install Pulumi Resource Plugins
        run: |
          pulumi plugin install resource aws v4.37.3;
          pulumi plugin install resource azure-native v1.56.0;
          pulumi plugin install resource kubernetes v3.15.1;
          pulumi plugin install resource gcp v6.11.0;
          pulumi plugin install resource random v4.3.1;
      - name: run example random
        run: |
          make bin/pulumi-language-jvm
          make provider.random.build provider.random.install
          export PATH="$PATH:$(pwd)/bin/" &&
            cd tests/examples/random &&
            ss=0
            pulumi destroy -s dev --yes || true
            pulumi stack rm dev --yes || true
            pulumi stack init dev || ((ss++))
            pulumi preview || ((ss++))
            pulumi up -s dev --yes || ((ss++))
            pulumi destroy -s dev --yes || ((ss++))
            exit $ss
    strategy:
      fail-fast: true
  example-eks-minimal:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          java-version: '11'
          distribution: 'adopt'
          cache: 'gradle'
      - name: Validate Gradle wrapper
        uses: gradle/wrapper-validation-action@e6e38bacfdf1a337459f332974bb2327a31aaf4b
      - name: Set up Go 1.17.x
        uses: actions/setup-go@v2
        with:
          go-version: 1.17.x
      - name: Configure Go cache
        id: go-cache-paths
        run: |
          echo "::set-output name=go-build::$(go env GOCACHE)"
          echo "::set-output name=go-mod::$(go env GOMODCACHE)"
      - name: Set up Go cache
        uses: actions/cache@v2
        id: go-cache
        with:
          path: |
              ${{ steps.go-cache-paths.outputs.go-build }}
              ${{ steps.go-cache-paths.outputs.go-mod }}
          key: go-cache-${{ hashFiles('**/go.sum') }}
      - name: Ensure dependencies
        run: make ensure
      - name: Publish Pulumi Java SDK to a local Maven repo
        run: make install_sdk
      - name: Install Pulumi CLI
        uses: pulumi/action-install-pulumi-cli@v2
      - name: Install Pulumi Resource Plugins
        run: make ensure_plugins
      - name: Build Java language provider
        run: make bin/pulumi-language-jvm
      - name: Build AWS provider
        run: make provider.aws.install
      - name: Build EKS provider
        run: make provider.eks.install
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-region: ${{ env.AWS_REGION }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          role-duration-seconds: 3600
          role-session-name: ${{ env.PROVIDER }}@githubActions
          role-to-assume: ${{ secrets.AWS_CI_ROLE_ARN }}
      - name: Run eks-minimal example
        run: make test_cloud_example.eks-minimal
    strategy:
      fail-fast: true
  go-lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    container: golangci/golangci-lint:latest
    name: Lint ${{ matrix.directory }}
    strategy:
      matrix:
        directory: [ pkg ]
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v2
        with:
          ref: ${{ env.PR_COMMIT_SHA }}
      - name: Lint ${{ matrix.directory }}
        run: |
          cd ${{ matrix.directory }} && golangci-lint run -c ../.golangci.yml